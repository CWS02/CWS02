@model List<prjWastes6.Models.SupplierInfo>
@using prjWastes6.Extensions;
@{
    Layout = "~/Views/Shared/_LayoutSpace.cshtml";
}
@{
    ViewBag.Title = "新供應商基本資料追蹤表";
}

<head>
    <link rel="stylesheet" href="~/css/style1.css" />
</head>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        alert('@TempData["SuccessMessage"]');
    </script>
}

<div class="container" style="margin-top: 50px;">
    <h2 class="text-center">新供應商基本資料追蹤表</h2>

    <form method="get" class="form-inline justify-content-center mb-4">
        <div class="form-group">
            <button class="btn btn-success" formaction="/Home/EditSupplierInfo" type="submit">新增</button>
        </div>
    </form>
</div>

<br />

<div class="container">
    <div class="card">
        <div class="card-body">
            <div class="table-responsive" style="overflow-x: auto;">
                <table class="table table-striped table-bordered table-hover ">
                    <thead>
                        <tr>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">編輯</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">序</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">建立日期</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">代號</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">廠商</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">基本資料</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">承諾書</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">保密協定</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">營登</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">匯款正本</th>
                            <th colspan="10" class="text-center">證書</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">社會責任</th>
                            <th colspan="8" class="text-center">環境評估</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">Reach</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">Reach種數</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">Rohs</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">無礦產</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">不使用物質</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">USEPA</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">檢驗記錄</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">委外評鑑</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">人員組織表</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">職安衛要求</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">填入Reach總表</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">簽核</th>
                            <th rowspan="2" class="text-center" style="vertical-align: middle;">完成歸檔</th>
                        </tr>
                        <tr>
                            <th>ISO 9001</th>
                            <th>OHSAS 18001 2007</th>
                            <th>ISO 45001 2018</th>
                            <th>ISO 14001 2015</th>
                            <th>ISO SA 8000</th>
                            <th>FSC</th>
                            <th>ISO TS16949</th>
                            <th>QC080000</th>
                            <th>IATF 16949:2016</th>
                            <th>ISO 50001:2011</th>
                            <th>環境汙染</th>
                            <th>汙染許可證</th>
                            <th>廢棄物</th>
                            <th>噪音</th>
                            <th>飲用水</th>
                            <th>消防</th>
                            <th>能源</th>
                            <th>緊急應變</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int count = 1;
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <form action="@Url.Action("EditSupplierInfo", "Home")" method="get">
                                            <input type="hidden" name="SUP000" value="@item.SUP000" />
                                            <button type="button" class="btn btn-warning" onclick="showPasswordPrompt('@item.SUP000')">
                                                <i class="fas fa-edit"></i> 編輯
                                            </button>
                                        </form>
                                    </td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@count</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP003</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP001</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP002</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP004.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP005.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP006.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP007.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP008.ToSymbol()</td>

                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP201</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP202</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP203</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP204</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP205</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP206</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP207</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP208</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP209</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP210</td>

                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP009.ToSymbol()</td>

                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP101.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP102.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP103.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP104.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP105.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP106.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP107.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP108.ToSymbol()</td>

                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP010.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP011</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP012.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP013.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP014.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP015.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP016.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP017.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP018.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP019.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP020</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP021.ToSymbol()</td>
                                    <td class="text-center align-middle" style="vertical-align: middle;">@item.SUP022.ToSymbol()</td>
                                </tr>
                                count++;
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function showPasswordPrompt(supplierId) {
        const password = prompt("請輸入密碼:");
        if (password === "CWS02") {
            window.location.href = '/Home/EditSupplierInfo?SUP000=' + supplierId;
        } else {
            alert("密碼錯誤，請重試。");
        }
    }

    //證書過期判斷
   document.addEventListener("DOMContentLoaded", function () {
    const expiredCertificates = {}; 

    const rows = document.querySelectorAll("tbody tr");
    rows.forEach(row => {
        const companyName = row.children[4].textContent; 
        const dateFields = [
            row.children[10].textContent,
            row.children[11].textContent,
            row.children[12].textContent,
            row.children[13].textContent,
            row.children[14].textContent,
            row.children[15].textContent,
            row.children[16].textContent,
            row.children[17].textContent,
            row.children[18].textContent,
            row.children[19].textContent,

        ];
        let count = 0; 
        const today = new Date(); 

        dateFields.forEach(dateField => {
            if (dateField) { 
                const dateValue = new Date(dateField.substring(0, 4), dateField.substring(4, 6) - 1, dateField.substring(6, 8)); 
                if (dateValue <= today) {
                    count++; 
                }
            }
        });
        if (count > 0) {
            if (expiredCertificates[companyName]) {
                expiredCertificates[companyName] += count; 
            } else {
                expiredCertificates[companyName] = count; 
            }
        }
    });
    let alertMessage = '';
    for (const [company, count] of Object.entries(expiredCertificates)) {
        alertMessage += `${company} 有 ${count} 筆證書過期\n`; 
    }
    if (alertMessage) {
        alert(alertMessage);
    }
});
</script>